import React, { useEffect, useState } from 'react';
const config = {
  API_HOST: "https://pluto-hotel-server-15c83810c41c.herokuapp.com",
};
const PackageDetailsPopup = ({ 
  isOpen, 
  onClose, 
  selectedPackage,
  selectedLead,
  hotelsByCity
}) => {
  const [packageMakerData, setPackageMakerData] = useState([]);

  useEffect(() => {
    const fetchPackageMaker = async () => {
      try {
        const response = await fetch(
          `${config.API_HOST}/api/packagemaker/get-packagemaker`
        );
        const data = await response.json();
        setPackageMakerData(data.data);
      } catch (error) {
        console.error('Error fetching package maker data:', error);
      }
    };

    fetchPackageMaker();
  }, []);

  if (!isOpen) return null;

  // Helper function to format currency
  const formatCurrency = (amount) => {
    return new Intl.NumberFormat('en-IN', {
      style: 'currency',
      currency: 'INR'
    }).format(amount);
  };

  return (
    <div style={{height:"350px",zIndex:"100"}} className="scroll-y-auto fixed inset-y-0 right-0 w-96 bg-white shadow-xl overflow-y-auto">
      {/* Header */}
      <div className="bg-[rgb(45,45,68)] px-6 py-4 text-white flex justify-between items-center">
        <h2 className="text-xl font-semibold">Package Details</h2>
      </div>

      {/* Content */}
      <div className="p-6 space-y-6">
        {/* Transfer Details */}
        <div className="border rounded-lg overflow-hidden">
          <div className="bg-gray-50 px-4 py-2 border-b">
            <h3 className="font-medium text-gray-900">Transfer Details</h3>
          </div>
          <div className="p-4">
            {selectedPackage?.cabs?.selectedCab ? (
              <div className="space-y-3">
                <div className="flex items-start space-x-3">
                  <div className="flex-1">
                    <h4 className="font-medium">{selectedPackage.cabs.selectedCab.cabName}</h4>
                    <p className="font-medium">{formatCurrency(selectedPackage.cabs.selectedCab.price)}</p>
                  </div>
                </div>
              </div>
            ) : (
              <p className="text-gray-500 text-center py-4">No transfer selected</p>
            )}
          </div>
        </div>

        {/* Hotels Details */}
        <div className="border rounded-lg overflow-hidden">
          <div className="bg-gray-50 px-4 py-2 border-b">
            <h3 className="font-medium text-gray-900">Hotel Details</h3>
          </div>
          <div className="divide-y">
            {selectedPackage?.package?.itineraryDays?.map((day, index) => {
              const hotel = day.selectedHotel || 
                (day?.selectedItinerary?.cityName && 
                  hotelsByCity[day.selectedItinerary.cityName.toLowerCase()]?.[0]);
              
              // Find matching hotel from packageMakerData
              const matchedHotel = packageMakerData.find(
                ph => ph.basicInfo.propertyName === hotel?.basicInfo?.propertyName
              );

              // Use matched hotel's data if available, otherwise fallback to original hotel
              const displayHotel = matchedHotel || hotel;

              return displayHotel ? (
                <div key={index} className="p-4">
                  <div className="space-y-3">
                    <div className="flex items-start space-x-3">
                      <div className="flex-1">
                        <h4 className="font-medium">{displayHotel.basicInfo.propertyName}</h4>
                        <div className="flex items-center gap-2 mt-1">
                          {/* You can add more hotel details here if needed */}
                        </div>
                        {displayHotel?.rooms?.data?.[0] && (
                          <div className="mt-2 text-sm">
                            <p className="font-medium">{displayHotel.rooms.data[0].roomName}</p>
                          </div>
                        )}
                      </div>
                      <div className="text-right">
                        <p className="font-medium">
                          {formatCurrency(displayHotel?.rooms?.data?.[0]?.baseRate || 0)}
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              ) : null;
            })}
          </div>
        </div>

        {/* Cost Summary */}
        <div className="border rounded-lg overflow-hidden">
          <div className="bg-gray-50 px-4 py-2 border-b">
            <h3 className="font-medium text-gray-900">Cost Summary</h3>
          </div>
          <div className="p-4 space-y-3">
            {/* Transfer Cost */}
            <div className="flex justify-between text-sm">
              <span>Total Transfer Cost:</span>
              <span>{formatCurrency(Number(selectedPackage?.cabs?.selectedCab?.price) || 0)}</span>
            </div>

            {/* Hotel Cost */}
            <div className="flex justify-between text-sm">
              <span>Total Hotel Cost:</span>
              <span>
                {formatCurrency(
                  selectedPackage?.package?.itineraryDays?.reduce((total, day) => {
                    const hotel = day.selectedHotel || 
                      (day?.selectedItinerary?.cityName && 
                        hotelsByCity[day.selectedItinerary.cityName.toLowerCase()]?.[0]);
                    
                    // Find matching hotel from packageMakerData
                    const matchedHotel = packageMakerData.find(
                      ph => ph.basicInfo.propertyName === hotel?.basicInfo?.propertyName
                    );
                    
                    // Use matched hotel's data if available, otherwise fallback to original hotel
                    const displayHotel = matchedHotel || hotel;
                    const hotelCost = Number(displayHotel?.rooms?.data?.[0]?.baseRate) || 0;
                    
                    console.log(`Hotel Cost for ${displayHotel?.basicInfo?.propertyName}:`, hotelCost);
                    return total + hotelCost;
                  }, 0) || 0
                )}
              </span>
            </div>

            {/* Grand Total */}
            <div className="pt-3 border-t flex justify-between font-medium">
              <span>Grand Total:</span>
              <span>
                {formatCurrency(
                  (Number(selectedPackage?.cabs?.selectedCab?.price) || 0) +
                  (selectedPackage?.package?.itineraryDays?.reduce((total, day) => {
                    const hotel = day.selectedHotel || 
                      (day?.selectedItinerary?.cityName && 
                        hotelsByCity[day.selectedItinerary.cityName.toLowerCase()]?.[0]);
                    
                    // Find matching hotel from packageMakerData
                    const matchedHotel = packageMakerData.find(
                      ph => ph.basicInfo.propertyName === hotel?.basicInfo?.propertyName
                    );
                    
                    // Use matched hotel's data if available, otherwise fallback to original hotel
                    const displayHotel = matchedHotel || hotel;
                    const hotelCost = Number(displayHotel?.rooms?.data?.[0]?.baseRate) || 0;
                    
                    return total + hotelCost;
                  }, 0) || 0)
                )}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default PackageDetailsPopup; 